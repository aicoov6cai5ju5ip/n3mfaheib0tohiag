<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <!-- Используем только CDN версии для совместимости -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.3.3/Tone.min.js" integrity="sha512-I79wZUgmp74ncFYBjsH+8919KYvBZT1/opDMPvRjdWJq+D9+AhQFyhKpVEdSmzxZ7gsxWZvNhXOK6W1FaHznzA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script src="https://unpkg.com/@tonejs/ui@0.0.8/build/tonejs-ui.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/tonal/browser/tonal.min.js"></script>
  
  <!-- Для MIDI парсинга -->
  <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
  <style type="text/css">
    /* ... ваш CSS ... */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      background-color: #1a1a1a;
      color: #eee;
    }
    tone-top-bar {
      flex-shrink: 0;
    }
    tone-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    #Description {
      margin-bottom: 20px;
      font-size: 1.1em;
      text-align: center;
    }
    #FileDrop {
      border: 2px dashed #555;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 20px;
      background-color: #2a2a2a;
      transition: background-color 0.2s;
      position: relative;
    }
    #FileDrop.Hover {
      background-color: #3a3a3a;
    }
    #FileDrop input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    #FileDrop #Text {
      font-size: 1.2em;
      color: #aaa;
    }
    #Results {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    #ResultsText {
      width: 100%;
      flex-grow: 1;
      background-color: #1a1a1a;
      border: 1px solid #444;
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      font-size: 0.9em;
      box-sizing: border-box;
      resize: vertical; /* Allow vertical resizing */
      min-height: 150px; /* Minimum height */
    }
    tone-play-toggle {
      align-self: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
      margin-bottom: 20px;
      justify-content: center;
      background-color: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .control-group label {
      margin-bottom: 5px;
      color: #ccc;
      font-size: 0.9em;
    }
    .control-group select, .control-group input[type="checkbox"] {
      background-color: #3a3a3a;
      border: 1px solid #555;
      color: #eee;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .control-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin-top: 5px; /* Adjust for alignment */
    }
    
    /* Transport Controls Styles */
    .transport-panel {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #444;
    }
    
    .transport-panel h3 {
      margin-top: 0;
      color: #4a90e2;
      border-bottom: 1px solid #444;
      padding-bottom: 8px;
    }
    
    .transport-buttons {
      margin-bottom: 15px;
    }
    
    .transport-buttons button {
      margin-right: 8px;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    #playBtn {
      background-color: #28a745;
      color: white;
    }
    
    #playBtn:hover:not(:disabled) {
      background-color: #218838;
    }
    
    #pauseBtn {
      background-color: #ffc107;
      color: black;
    }
    
    #pauseBtn:hover:not(:disabled) {
      background-color: #e0a800;
    }
    
    #stopBtn {
      background-color: #dc3545;
      color: white;
    }
    
    #stopBtn:hover:not(:disabled) {
      background-color: #c82333;
    }
    
    .transport-buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #bpmInput {
      width: 60px;
      text-align: center;
      margin: 0 5px;
      background-color: #3a3a3a;
      border: 1px solid #555;
      color: #eee;
      padding: 4px;
      border-radius: 4px;
    }
    
    #bpmDown, #bpmUp {
      padding: 4px 8px;
      background: #555;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    #bpmDown:hover, #bpmUp:hover {
      background: #666;
    }
    
    #positionDisplay, #barsDisplay {
      font-family: monospace;
      background: #1a1a1a;
      padding: 4px 8px;
      border-radius: 3px;
      margin: 0 5px;
    }
    
    #positionSlider {
      width: 100%;
      margin: 5px 0;
    }
    
    #advancedToggle {
      padding: 5px 10px;
      background: #555;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    #advancedToggle:hover {
      background: #666;
    }
    
    #advancedPanel {
      border-top: 1px solid #555;
      padding-top: 15px;
    }
    
    #swingSlider {
      width: 200px;
      margin-right: 10px;
    }
    
    .transport-info {
      font-size: 12px;
      color: #ccc;
      border-top: 1px solid #444;
      padding-top: 10px;
    }
    
    #loopSettings label {
      margin-right: 15px;
    }
    
    #loopSettings input {
      width: 60px;
      padding: 2px;
      margin-left: 5px;
      background-color: #3a3a3a;
      border: 1px solid #555;
      color: #eee;
      border-radius: 3px;
    }
  </style>
</head><body>
  <tone-top-bar></tone-top-bar>
  <tone-content>
    <div id="Description">
      Parse a MIDI file into a Tone.js-friendly JSON format and play with custom tunings.
    </div>
    <div id="FileDrop">
      <div id="Text">
        Drop a midi file here
      </div>
      <input type="file" accept="audio/midi">
    </div>

    <!-- Добавляем элементы управления -->
    <div class="controls">
      <div class="control-group">
      <label for="tuningSystem">Музыкальный строй:</label>
      <select id="tuningSystem">
        <option value="equal">Равномерно темперированный строй</option>
        <option value="natural">Натуральный строй</option>
        <option value="pythagorean">Пифагоров строй</option>
        <option value="pentatonic">Пентаграмный строй</option>
      </select>
      </div>
      
      <div class="control-group">
      <label for="useInternalSynth">Использовать встроенный синтезатор:</label>
      <input type="checkbox" id="useInternalSynth" checked>
      </div>
      
      <div class="control-group">
      <label for="useExternalSynth">Подключить внешний синтезатор:</label>
      <input type="checkbox" id="useExternalSynth">
      </div>
      
      <div class="control-group">
      <label for="synthType">Тип синтезатора:</label>
      <select id="synthType">
        <option value="default">Basic Synth (Triangle)</option>
        <option value="fm">FM Synth</option>
        <option value="am">AM Synth</option>
        <option value="membrane">Membrane Synth</option>
      </select>
      </div>
      
      <!-- Enhanced Transport Controls -->
      <div id="TransportControls" class="transport-panel">
        <h3>Transport Controls</h3>
        
        <!-- BPM Control -->
        <div class="control-group">
          <label>BPM: </label>
          <button id="bpmDown">-</button>
          <input type="number" id="bpmInput" value="120" min="20" max="300">
          <button id="bpmUp">+</button>
          <span id="bpmDisplay">120 BPM</span>
        </div>
        
        <!-- Position Display -->
        <div class="control-group">
          <label>Position: </label>
          <span id="positionDisplay">0:00.00</span>
          <span> | </span>
          <span id="barsDisplay">0:0:0</span>
        </div>
        
        <!-- Position Scrubber -->
        <div class="control-group">
          <input type="range" id="positionSlider" min="0" max="100" value="0" disabled>
        </div>
        
        <!-- Advanced Controls Toggle -->
        <button id="advancedToggle">▼ Advanced</button>
        
        <!-- Advanced Controls Panel -->
        <div id="advancedPanel" style="display:none;">
          <!-- Loop Controls -->
          <div class="control-group">
            <label><input type="checkbox" id="loopEnabled"> Enable Loop</label>
            <div id="loopSettings" style="display:none; margin-left:20px;">
              <label>Start: <input type="text" id="loopStart" value="0:0:0"></label>
              <label>End: <input type="text" id="loopEnd" value="4:0:0"></label>
            </div>
          </div>
          
          <!-- Swing Controls -->
          <div class="control-group">
            <label>Swing: <span id="swingDisplay">0%</span></label>
            <input type="range" id="swingSlider" min="0" max="100" value="0">
            <select id="swingSubdivision">
              <option value="8n">8th notes</option>
              <option value="16n" selected>16th notes</option>
              <option value="32n">32nd notes</option>
            </select>
          </div>
          
          <!-- Transport Info -->
          <div class="transport-info">
            <div>State: <span id="transportState">Stopped</span></div>
            <div>Duration: <span id="durationDisplay">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <div id="Results">
      <textarea id="ResultsText" placeholder="json output..."></textarea>
    </div>
    <tone-play-toggle disabled=""></tone-play-toggle>
  </tone-content>

  <!-- 4. Загружаем ваш pianoroll-core.js как модуль -->
  <script type="module" src="pianoroll-core.js"></script>

  <!-- 5. Ваш основной скрипт, также как модуль -->
  <script type="module">
    // Используем глобальные объекты вместо импортов
    const { Midi } = window;

    import PianoRollCore from './pianoroll-core.js'; // Ваш модуль

    if (
      !(
        window.File &&
        window.FileReader &&
        window.FileList &&
        window.Blob
      )
    ) {
      document.querySelector("#FileDrop #Text").textContent =
        "Reading files not supported by this browser";
    } else {
      const fileDrop = document.querySelector("#FileDrop");

      fileDrop.addEventListener("dragenter", () =>
        fileDrop.classList.add("Hover")
      );

      fileDrop.addEventListener("dragleave", () =>
        fileDrop.classList.remove("Hover")
      );

      fileDrop.addEventListener("drop", () =>
        fileDrop.classList.remove("Hover")
      );

      document
        .querySelector("#FileDrop input")
        .addEventListener("change", (e) => {
          const files = e.target.files;
          if (files.length > 0) {
            const file = files[0];
            document.querySelector(
              "#FileDrop #Text"
            ).textContent = file.name;
            parseFile(file);
          }
        });
    }

    let currentMidi = null;
    let pianoRoll = null; // Объявляем pianoRoll здесь, чтобы он был доступен

    function parseFile(file) {
      const reader = new FileReader();
      reader.onload = async function (e) {
        const midi = new Midi(e.target.result);
        currentMidi = midi;

        // Инициализируем PianoRollCore, если еще не инициализирован
        if (!pianoRoll) {
          pianoRoll = new PianoRollCore({
            tuningSystem: document.querySelector('#tuningSystem').value,
            useSynth: document.querySelector('#useInternalSynth').checked,
            synthType: document.querySelector('#synthType').value
          });
          
          // Subscribe to transport events if the method exists
          if (pianoRoll.subscribeToTransport) {
            pianoRoll.subscribeToTransport((event) => {
              if (event.type === 'play') {
                transportState.isPlaying = true;
                transportState.isPaused = false;
              } else if (event.type === 'pause') {
                transportState.isPlaying = false;
                transportState.isPaused = true;
              } else if (event.type === 'stop') {
                transportState.isPlaying = false;
                transportState.isPaused = false;
                transportState.position = 0;
              } else if (event.type === 'position' && event.data) {
                transportState.position = event.data.positionSeconds || 0;
                // Update position display
                const posDisplay = document.getElementById('positionDisplay');
                const barsDisplay = document.getElementById('barsDisplay');
                if (posDisplay && event.data.positionSeconds !== undefined) {
                  const seconds = event.data.positionSeconds;
                  const mins = Math.floor(seconds / 60);
                  const secs = Math.floor(seconds % 60);
                  const ms = Math.floor((seconds % 1) * 100);
                  posDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
                }
                if (barsDisplay && event.data.position) {
                  barsDisplay.textContent = event.data.position;
                }
              }
              updateTransportUI();
            });
          }
          
           // Подписываем внешний синтезатор, если чекбокс активен при загрузке MIDI
          if (document.querySelector('#useExternalSynth').checked) {
            pianoRoll.subscribe(externalSynthCallback);
          }
        } else {
          pianoRoll.stop(); // Останавливаем предыдущее воспроизведение, если оно было
        }
        
        pianoRoll.loadMidiJson(currentMidi);

        document.querySelector(
          "#ResultsText"
        ).value = JSON.stringify(pianoRoll.getNotes(), undefined, 2);
        document
          .querySelector("tone-play-toggle")
          .removeAttribute("disabled");
          
        // Enable transport controls
        document.getElementById('positionSlider').disabled = false;
        
        // Update duration display
        transportState.duration = midi.duration;
        document.getElementById('durationDisplay').textContent = 
          Math.floor(midi.duration / 60) + ':' + 
          Math.floor(midi.duration % 60).toString().padStart(2, '0');
        
        // Set position slider max
        document.getElementById('positionSlider').max = Math.floor(midi.duration);
        
        // Update UI
        updateTransportUI();
        
        document
          .addEventListener("play", async (e) => { // Добавляем async здесь
              const playing = e.detail;
              if (playing && currentMidi && pianoRoll) {
                  // !!! ВАЖНО: Запускаем Tone.js AudioContext после действия пользователя
                  await window.Tone.start();
                  
                  // Apply transport settings before playing
                  applyTransportSettings();
                  pianoRoll.play();
              } else if (pianoRoll) {
                  pianoRoll.stop();
              }
          });
      };
      reader.readAsArrayBuffer(file);
    }

    // Обработка кнопки воспроизведения
    document
      .querySelector("tone-play-toggle")
      .addEventListener("play", (e) => {
        const playing = e.detail;
        if (playing && currentMidi && pianoRoll) {
          // Apply transport settings before playing
          applyTransportSettings();
          pianoRoll.play();
        } else if (pianoRoll) {
          pianoRoll.stop();
        }
      });

    // Обработчики для элементов управления
    document.querySelector('#tuningSystem').addEventListener('change', (e) => {
      if (pianoRoll) {
        pianoRoll.setTuningSystem(e.target.value);
        document.querySelector('#ResultsText').value =
          JSON.stringify(pianoRoll.getNotes(), null, 2);
      }
    });

    document.querySelector('#useInternalSynth').addEventListener('change', (e) => {
      if (pianoRoll) {
        pianoRoll.toggleSynth(e.target.checked);
      }
    });

    document.querySelector('#synthType').addEventListener('change', (e) => {
      if (pianoRoll) {
        pianoRoll.setSynthType(e.target.value);
      }
    });

    // Пример подписки на события нот для внешнего синтезатора
    const externalSynthCallback = (event) => {
      if (event.type === 'noteOn') {
        console.log(`[External Synth] Playing note: ${event.note} (${event.frequency.toFixed(2)}Hz) at ${event.time.toFixed(2)}s for ${event.duration.toFixed(2)}s`);
        // Здесь был бы код для запуска внешнего синтезатора
      } else if (event.type === 'noteOff') {
        console.log(`[External Synth] Stopping note: ${event.note} at ${event.time.toFixed(2)}s`);
        // Здесь был бы код для остановки ноты на внешнем синтезаторе
      } else if (event.type === 'stop') {
        console.log(`[External Synth] Playback stopped.`);
      }
    };

    document.querySelector('#useExternalSynth').addEventListener('change', (e) => {
      if (pianoRoll) {
        if (e.target.checked) {
          pianoRoll.subscribe(externalSynthCallback);
          console.log("External synth callback subscribed.");
        } else {
          pianoRoll.unsubscribe(externalSynthCallback);
          console.log("External synth callback unsubscribed.");
        }
      }
    });

    // Function to apply all transport settings to PianoRoll
    function applyTransportSettings() {
      if (!pianoRoll) return;
      
      try {
        // Apply BPM
        const bpmInput = document.getElementById('bpmInput');
        if (bpmInput && bmpInput.value) {
          const bpm = parseInt(bmpInput.value);
          if (bpm >= 20 && bpm <= 300) {
            pianoRoll.setBPM(bpm);
            console.log('Applied BPM:', bpm);
          }
        }
        
        // Apply loop settings
        const loopEnabled = document.getElementById('loopEnabled');
        if (loopEnabled && loopEnabled.checked) {
          const loopStart = document.getElementById('loopStart')?.value || '0:0:0';
          const loopEnd = document.getElementById('loopEnd')?.value || '4:0:0';
          pianoRoll.setLoop(true, loopStart, loopEnd);
          console.log('Applied loop:', loopStart, 'to', loopEnd);
        } else if (loopEnabled) {
          pianoRoll.setLoop(false);
        }
        
        // Apply swing settings
        const swingSlider = document.getElementById('swingSlider');
        const swingSubdivision = document.getElementById('swingSubdivision');
        if (swingSlider && swingSubdivision) {
          const swingAmount = parseInt(swingSlider.value) / 100;
          pianoRoll.setSwing(swingAmount, swingSubdivision.value);
          console.log('Applied swing:', swingAmount, swingSubdivision.value);
        }
        
        console.log('Transport settings applied successfully');
      } catch (error) {
        console.error('Error applying transport settings:', error);
      }
    }
    
    // Transport controls initialization
    function updateTransportUI() {
      const transportStateSpan = document.getElementById('transportState');
      if (transportStateSpan) {
        if (transportState.isPlaying) {
          transportStateSpan.textContent = 'Playing';
        } else if (transportState.isPaused) {
          transportStateSpan.textContent = 'Paused';
        } else {
          transportStateSpan.textContent = 'Stopped';
        }
      }
    }
    
    // Initialize transport controls
    document.addEventListener('DOMContentLoaded', function() {
      // BPM controls
      const bpmInput = document.getElementById('bpmInput');
      const bpmDown = document.getElementById('bpmDown');
      const bpmUp = document.getElementById('bpmUp');
      const bpmDisplay = document.getElementById('bpmDisplay');
      
      if (bpmDown) {
        bpmDown.addEventListener('click', () => {
          let bpm = parseInt(bpmInput.value) || 120;
          bpm = Math.max(20, bpm - 1);
          bpmInput.value = bpm;
          bpmDisplay.textContent = bpm + ' BPM';
          if (pianoRoll && pianoRoll.setBPM) {
            pianoRoll.setBPM(bpm);
          }
        });
      }
      
      if (bpmUp) {
        bpmUp.addEventListener('click', () => {
          let bpm = parseInt(bpmInput.value) || 120;
          bpm = Math.min(300, bpm + 1);
          bpmInput.value = bpm;
          bpmDisplay.textContent = bpm + ' BPM';
          if (pianoRoll && pianoRoll.setBPM) {
            pianoRoll.setBPM(bpm);
          }
        });
      }
      
      if (bpmInput) {
        bpmInput.addEventListener('input', () => {
          const bpm = parseInt(bpmInput.value);
          if (bpm >= 20 && bpm <= 300) {
            bpmDisplay.textContent = bpm + ' BPM';
            if (pianoRoll && pianoRoll.setBPM) {
              pianoRoll.setBPM(bpm);
            }
          }
        });
      }
      
      // Advanced panel toggle
      const advancedToggle = document.getElementById('advancedToggle');
      const advancedPanel = document.getElementById('advancedPanel');
      if (advancedToggle && advancedPanel) {
        advancedToggle.addEventListener('click', () => {
          const isVisible = advancedPanel.style.display !== 'none';
          advancedPanel.style.display = isVisible ? 'none' : 'block';
          advancedToggle.textContent = isVisible ? '▼ Advanced' : '▲ Advanced';
        });
      }
      
      // Loop controls
      const loopEnabled = document.getElementById('loopEnabled');
      const loopSettings = document.getElementById('loopSettings');
      if (loopEnabled && loopSettings) {
        loopEnabled.addEventListener('change', () => {
          loopSettings.style.display = loopEnabled.checked ? 'block' : 'none';
          if (pianoRoll && pianoRoll.setLoop) {
            const start = document.getElementById('loopStart')?.value || '0:0:0';
            const end = document.getElementById('loopEnd')?.value || '4:0:0';
            pianoRoll.setLoop(loopEnabled.checked, start, end);
            console.log('Loop', loopEnabled.checked ? 'enabled' : 'disabled', 'from', start, 'to', end);
          }
        });
      }
      
      // Swing controls
      const swingSlider = document.getElementById('swingSlider');
      const swingDisplay = document.getElementById('swingDisplay');
      if (swingSlider && swingDisplay) {
        swingSlider.addEventListener('input', () => {
          const swingAmount = parseInt(swingSlider.value) / 100;
          swingDisplay.textContent = swingSlider.value + '%';
          if (pianoRoll && pianoRoll.setSwing) {
            const subdivision = document.getElementById('swingSubdivision')?.value || '16n';
            pianoRoll.setSwing(swingAmount, subdivision);
            console.log('Swing set to:', swingAmount, 'subdivision:', subdivision);
          }
        });
      }
    });
    
    // Инициализация Tone.Transport (если еще не сделано)
    // Tone.js обычно инициализирует его сам, но убедимся, что он запущен
    // Tone.Transport.start() будет вызван при запуске воспроизведения
  </script>
</body></html>